<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:BerryAIGCToolbox.ViewModels"
             xmlns:dto="using:AIGenManager.Application.DTOs"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="BerryAIGCToolbox.Views.ImportWizardView"
             x:DataType="vm:ImportWizardViewModel">
  <Design.DataContext>
    <vm:ImportWizardViewModel/>
  </Design.DataContext>
  
  <Grid RowDefinitions="Auto,*,Auto">
    <!-- Header -->
    <Border Grid.Row="0" Background="{DynamicResource SystemAccentColor}" Padding="20">
      <TextBlock Text="Import Images" FontSize="24" FontWeight="Bold" Foreground="White"/>
    </Border>
    
    <!-- Main Content -->
    <ScrollViewer Grid.Row="1" Padding="20">
      <StackPanel Spacing="20">
        <!-- Folder Selection -->
        <Border Background="{DynamicResource SystemChromeLowColor}" CornerRadius="8" Padding="20">
          <StackPanel Spacing="15">
            <TextBlock Text="Select Folder to Import" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>
            
            <Grid ColumnDefinitions="*,Auto">
              <TextBox Grid.Column="0" 
                       Text="{Binding SelectedFolderPath}" 
                       Watermark="Enter folder path..."
                       IsReadOnly="True"
                       Margin="0,0,10,0"/>
              <Button Grid.Column="1" 
                      Content="Browse..." 
                      Command="{Binding SelectFolderCommand}"
                      Padding="20,8"/>
            </Grid>
            
            <CheckBox Content="Include subfolders" 
                     IsChecked="{Binding IsRecursive}"
                     Margin="0,10,0,0"/>
          </StackPanel>
        </Border>
        
        <!-- Import Progress -->
        <Border Background="{DynamicResource SystemChromeLowColor}" CornerRadius="8" Padding="20" 
                IsVisible="{Binding IsImporting}">
          <StackPanel Spacing="15">
            <TextBlock Text="Import Progress" FontSize="18" FontWeight="SemiBold"/>
            
            <ProgressBar Value="{Binding CurrentProgress}" 
                       Maximum="{Binding TotalProgress}"
                       Height="30"
                       Margin="0,10,0,0"/>
            
            <Grid ColumnDefinitions="Auto,*">
              <TextBlock Grid.Column="0" 
                         Text="{Binding CurrentProgress, StringFormat='{}{0} / '}"
                         VerticalAlignment="Center"/>
              <TextBlock Grid.Column="1" 
                         Text="{Binding TotalProgress}"
                         VerticalAlignment="Center"
                         Margin="5,0,0,0"/>
            </Grid>
            
            <TextBlock Text="{Binding CurrentFile}" 
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       Margin="0,10,0,0"/>
          </StackPanel>
        </Border>
        
        <!-- Import Results -->
        <Border Background="{DynamicResource SystemChromeLowColor}" CornerRadius="8" Padding="20" 
                IsVisible="{Binding ImportResult, Converter={x:Static ObjectConverters.IsNotNull}}">
          <StackPanel Spacing="15">
            <TextBlock Text="Import Results" FontSize="18" FontWeight="SemiBold"/>
            
            <Grid ColumnDefinitions="*,*,*" Margin="0,10,0,0">
              <Border Grid.Column="0" Background="{DynamicResource SystemAccentColorLight3}" CornerRadius="4" Padding="15,10">
                <StackPanel Spacing="5">
                  <TextBlock Text="Total" FontSize="14" FontWeight="SemiBold" Foreground="White"/>
                  <TextBlock Text="{Binding ImportResult.TotalImages}" FontSize="24" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                </StackPanel>
              </Border>
              
              <Border Grid.Column="1" Background="#4CAF50" CornerRadius="4" Padding="15,10" Margin="10,0">
                <StackPanel Spacing="5">
                  <TextBlock Text="Success" FontSize="14" FontWeight="SemiBold" Foreground="White"/>
                  <TextBlock Text="{Binding ImportResult.SuccessfullyImported}" FontSize="24" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                </StackPanel>
              </Border>
              
              <Border Grid.Column="2" Background="#F44336" CornerRadius="4" Padding="15,10">
                <StackPanel Spacing="5">
                  <TextBlock Text="Failed" FontSize="14" FontWeight="SemiBold" Foreground="White"/>
                  <TextBlock Text="{Binding ImportResult.FailedToImport}" FontSize="24" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                </StackPanel>
              </Border>
            </Grid>
            
            <!-- Error List -->
            <Expander Header="Import Errors" IsExpanded="True" Margin="0,15,0,0"
                      IsVisible="{Binding ImportResult.FailedToImport, Converter={x:Static ObjectConverters.IsNotNull}}">
              <ListBox ItemsSource="{Binding Errors}" 
                       MaxHeight="300"
                       Margin="0,10,0,0">
                <ListBox.ItemTemplate>
                  <DataTemplate x:DataType="dto:ImportErrorDTO">
                    <Border Background="{DynamicResource SystemChromeMediumColor}" 
                            CornerRadius="4" 
                            Padding="10"
                            Margin="0,5">
                      <StackPanel Spacing="5">
                        <TextBlock Text="{Binding FilePath}" FontWeight="SemiBold" TextWrapping="Wrap"/>
                        <TextBlock Text="{Binding ErrorType}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                        <TextBlock Text="{Binding ErrorMessage}" 
                                   Foreground="#F44336" 
                                   TextWrapping="Wrap"/>
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </Expander>
          </StackPanel>
        </Border>
        
        <!-- Manual Metadata Entry -->
        <Border Background="{DynamicResource SystemChromeLowColor}" CornerRadius="8" Padding="20" 
                IsVisible="{Binding ShowManualMetadataEntry}">
          <StackPanel Spacing="15">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Grid.Column="0" Text="Manual Metadata Entry" FontSize="18" FontWeight="SemiBold"/>
              <Button Grid.Column="1" 
                      Content="Ã—" 
                      Command="{Binding CloseManualMetadataEntryCommand}"
                      FontSize="20"
                      Padding="10,5"/>
            </Grid>
            
            <TextBlock Text="{Binding ManualMetadataFilePath}" 
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       Margin="0,10,0,0"/>
            
            <Grid ColumnDefinitions="*,*" Margin="0,10,0,0">
              <StackPanel Grid.Column="0" Spacing="10">
                <TextBlock Text="Prompt" FontWeight="SemiBold"/>
                <TextBox Text="{Binding ManualMetadata.Prompt}" 
                         AcceptsReturn="True" 
                         TextWrapping="Wrap"
                         Height="80"/>
              </StackPanel>
              
              <StackPanel Grid.Column="1" Spacing="10" Margin="10,0,0,0">
                <TextBlock Text="Negative Prompt" FontWeight="SemiBold"/>
                <TextBox Text="{Binding ManualMetadata.NegativePrompt}" 
                         AcceptsReturn="True" 
                         TextWrapping="Wrap"
                         Height="80"/>
              </StackPanel>
            </Grid>
            
            <Grid ColumnDefinitions="*,*,*,*" Margin="0,10,0,0">
              <StackPanel Grid.Column="0" Spacing="5">
                <TextBlock Text="Steps" FontWeight="SemiBold"/>
                <NumericUpDown Value="{Binding ManualMetadata.Steps}" Minimum="0" Maximum="1000"/>
              </StackPanel>
              
              <StackPanel Grid.Column="1" Spacing="5" Margin="10,0,0,0">
                <TextBlock Text="Sampler" FontWeight="SemiBold"/>
                <TextBox Text="{Binding ManualMetadata.Sampler}"/>
              </StackPanel>
              
              <StackPanel Grid.Column="2" Spacing="5" Margin="10,0,0,0">
                <TextBlock Text="CFG Scale" FontWeight="SemiBold"/>
                <NumericUpDown Value="{Binding ManualMetadata.CFGScale}" Minimum="0" Maximum="30" Increment="0.5"/>
              </StackPanel>
              
              <StackPanel Grid.Column="3" Spacing="5" Margin="10,0,0,0">
                <TextBlock Text="Seed" FontWeight="SemiBold"/>
                <NumericUpDown Value="{Binding ManualMetadata.Seed}" Minimum="0" Maximum="9999999999"/>
              </StackPanel>
            </Grid>
            
            <Grid ColumnDefinitions="*,*" Margin="0,10,0,0">
              <StackPanel Grid.Column="0" Spacing="5">
                <TextBlock Text="Width" FontWeight="SemiBold"/>
                <NumericUpDown Value="{Binding ManualMetadata.Width}" Minimum="0" Maximum="8192"/>
              </StackPanel>
              
              <StackPanel Grid.Column="1" Spacing="5" Margin="10,0,0,0">
                <TextBlock Text="Height" FontWeight="SemiBold"/>
                <NumericUpDown Value="{Binding ManualMetadata.Height}" Minimum="0" Maximum="8192"/>
              </StackPanel>
            </Grid>
            
            <Grid ColumnDefinitions="*,*" Margin="0,10,0,0">
              <StackPanel Grid.Column="0" Spacing="5">
                <TextBlock Text="Model Name" FontWeight="SemiBold"/>
                <TextBox Text="{Binding ManualMetadata.ModelName}"/>
              </StackPanel>
              
              <StackPanel Grid.Column="1" Spacing="5" Margin="10,0,0,0">
                <TextBlock Text="Model Hash" FontWeight="SemiBold"/>
                <TextBox Text="{Binding ManualMetadata.ModelHash}"/>
              </StackPanel>
            </Grid>
            
            <Grid ColumnDefinitions="*,Auto" Margin="0,15,0,0">
              <Button Grid.Column="1" 
                      Content="Save Metadata" 
                      Command="{Binding SaveManualMetadataCommand}"
                      Padding="20,8"/>
            </Grid>
          </StackPanel>
        </Border>
      </StackPanel>
    </ScrollViewer>
    
    <!-- Footer Actions -->
    <Border Grid.Row="2" Background="{DynamicResource SystemChromeLowColor}" Padding="20">
      <Grid ColumnDefinitions="*,Auto,Auto,Auto">
        <TextBlock Grid.Column="0" 
                   Text="{Binding StatusMessage}" 
                   VerticalAlignment="Center"
                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
        
        <Button Grid.Column="1" 
                Content="Start Import" 
                Command="{Binding StartImportCommand}"
                IsEnabled="{Binding IsNotImporting}"
                Padding="20,8"
                Margin="10,0,0,0"/>
        
        <Button Grid.Column="2" 
                Content="Clear Results" 
                Command="{Binding ClearImportResultCommand}"
                IsEnabled="{Binding ImportResult, Converter={x:Static ObjectConverters.IsNotNull}}"
                Padding="20,8"
                Margin="10,0,0,0"/>
        
        <Button Grid.Column="3" 
                Content="Close" 
                Padding="20,8"
                Margin="10,0,0,0"/>
      </Grid>
    </Border>
  </Grid>
</UserControl>